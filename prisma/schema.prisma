generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── User & Auth ─────────────────────────────────────────────────────────────

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Social identity
  username      String?  @unique
  displayName   String?
  bio           String?
  avatarUrl     String?
  isPrivate     Boolean  @default(false)

  profile         Profile?
  subscription    Subscription?
  workoutLogs     WorkoutLog[]
  nutritionLogs   NutritionLog[]
  weeklyReports   WeeklyReport[]
  achievements    UserAchievement[]
  streak          Streak?
  personalRecords PersonalRecord[]
  exerciseAnalytics UserExerciseAnalytics[]
  coachMessages   CoachMessage[]

  // Social relations
  followers        Follow[]        @relation("Following")
  following        Follow[]        @relation("Followers")
  activities       Activity[]
  sharedWorkouts   SharedWorkout[]
  likes            Like[]
  comments         Comment[]
  blockedUsers     Block[]         @relation("Blocker")
  blockedBy        Block[]         @relation("Blocked")
  notifications    Notification[]
  followRequests   FollowRequest[] @relation("RequestReceiver")
  sentRequests     FollowRequest[] @relation("RequestSender")
  cardioActivities CardioActivity[]
  workoutCopies    WorkoutCopy[]
}

model Profile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic info
  name   String?
  age    Int?
  gender String? // male, female, other
  weight Float?  // in kg
  height Float?  // in cm

  // Onboarding
  goal            String? // fat_loss, muscle_gain, strength, endurance, general
  experienceLevel String? // beginner, intermediate, advanced
  trainingDays    Int?    // 2-6
  equipment       String? // full_gym, home_gym, minimal, bodyweight
  injuries        String  @default("[]") // JSON array
  sport           String? // basketball, running, mma, etc.

  // Calculated
  bmr            Float?
  tdee           Float?
  targetCalories Float?
  targetProtein  Float?
  targetCarbs    Float?
  targetFat      Float?

  // Preferences
  unitSystem String @default("imperial") // imperial or metric

  // Onboarding state
  onboardingDone  Boolean @default(false)
  goalDescription String?

  currentPlan TrainingPlan?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Training System ──────────────────────────────────────────────────────────

model TrainingPlan {
  id        String  @id @default(cuid())
  userId    String  @unique
  profile   Profile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  name            String  // "Hypertrophy Block 1"
  type            String  // custom, strength, hypertrophy, powerlifting, sport_specific
  split           String  // ppl, upper_lower, full_body, bro_split
  daysPerWeek     Int
  currentWeek     Int     @default(1)
  currentPhase    String? // accumulation, intensification, peaking, deload

  mesocycleLength Int @default(4) // weeks
  deloadFrequency Int @default(4) // every N weeks

  workouts Workout[]

  startedAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Workout {
  id     String       @id @default(cuid())
  planId String
  plan   TrainingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  name      String  // "Push A", "Upper Body"
  dayOfWeek Int?    // 0-6
  order     Int

  exercises      WorkoutExercise[]
  logs           WorkoutLog[]
  sharedWorkouts SharedWorkout[]

  createdAt DateTime @default(now())
}

model Exercise {
  id   String @id @default(cuid())
  name String @unique

  category         String  // compound, isolation, cardio
  muscleGroups     String  @default("[]") // JSON array
  secondaryMuscles String  @default("[]") // JSON array
  equipment        String  @default("[]") // JSON array
  fatigueRating    Float   @default(1.0)
  skillLevel       String  @default("beginner")
  avoidIfInjury    String  @default("[]") // JSON array
  instructions     String?
  videoUrl         String?

  // Exercise visuals
  gifUrl          String?
  muscleImageUrl  String?
  formTips        String  @default("[]") // JSON array
  commonMistakes  String  @default("[]") // JSON array
  externalId      String?
  source          String? // exercisedb, musclewiki, custom

  workoutExercises WorkoutExercise[]
  exerciseLogs     ExerciseLog[]
  personalRecords  PersonalRecord[]
}

model WorkoutExercise {
  id         String   @id @default(cuid())
  workoutId  String
  workout    Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id])

  order        Int
  sets         Int
  repsMin      Int
  repsMax      Int
  rpe          Float?
  restSeconds  Int    @default(120)
  supersetGroup Int?
  notes        String?
}

// ─── Logging & Tracking ───────────────────────────────────────────────────────

model WorkoutLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutId String
  workout   Workout  @relation(fields: [workoutId], references: [id])

  startedAt   DateTime
  completedAt DateTime?
  duration    Int? // minutes

  exerciseLogs ExerciseLog[]

  overallRpe  Float?
  energyLevel Int?
  mood        Int?
  notes       String?

  createdAt DateTime @default(now())
}

model ExerciseLog {
  id           String     @id @default(cuid())
  workoutLogId String
  workoutLog   WorkoutLog @relation(fields: [workoutLogId], references: [id], onDelete: Cascade)
  exerciseId   String
  exercise     Exercise   @relation(fields: [exerciseId], references: [id])

  sets SetLog[]

  createdAt DateTime @default(now())
}

model SetLog {
  id            String      @id @default(cuid())
  exerciseLogId String
  exerciseLog   ExerciseLog @relation(fields: [exerciseLogId], references: [id], onDelete: Cascade)

  setNumber   Int
  weight      Float
  reps        Int
  rpe         Float?
  rir         Int?
  isWarmup    Boolean  @default(false)
  isPR        Boolean  @default(false)
  completedAt DateTime @default(now())
}

model PersonalRecord {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id])

  type       String // 1rm, 3rm, 5rm, volume
  value      Float
  reps       Int?
  achievedAt DateTime @default(now())
}

// ─── Nutrition ────────────────────────────────────────────────────────────────

model NutritionLog {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date    DateTime @default(now())
  calories Float
  protein  Float
  carbs    Float
  fat      Float

  mealName        String?
  foodDescription String?

  createdAt DateTime @default(now())
}

// ─── AI Intelligence ──────────────────────────────────────────────────────────

model WeeklyReport {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  weekStart DateTime
  weekEnd   DateTime

  workoutsCompleted Int
  totalVolume       Float
  avgRpe            Float?
  prsHit            Int
  streakDays        Int

  insights        String @default("[]") // JSON array
  recommendations String @default("[]") // JSON array

  volumeTrend    String?
  strengthTrend  String?
  recoveryScore  Float?

  // AI-generated fields
  overallScore      Int?
  motivationalNote  String?
  focusForNextWeek  String?
  nutritionAdherence Float?
  planAdjustments   String @default("[]") // JSON array
  warnings          String @default("[]") // JSON array

  createdAt DateTime @default(now())
}

model UserExerciseAnalytics {
  id         String @id @default(cuid())
  userId     String
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  exerciseId String

  estimatedMax    Float?
  volumeResponse  Float?
  fatigueResponse Float?
  optimalRepRange String?
  optimalVolume   Int?

  lastUpdated DateTime @updatedAt

  @@unique([userId, exerciseId])
}

// ─── Gamification ─────────────────────────────────────────────────────────────

model Achievement {
  id          String @id @default(cuid())
  code        String @unique
  name        String
  description String
  icon        String
  category    String // strength, consistency, nutrition, milestone
  requirement String // JSON condition
  xpReward    Int    @default(100)

  users UserAchievement[]
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id])

  unlockedAt DateTime @default(now())

  @@unique([userId, achievementId])
}

model Streak {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  currentStreak   Int       @default(0)
  longestStreak   Int       @default(0)
  lastWorkoutDate DateTime?

  updatedAt DateTime @updatedAt
}

// ─── AI Coach ────────────────────────────────────────────────────────────────

model CoachMessage {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String   // user | coach
  content   String
  createdAt DateTime @default(now())

  @@index([userId])
}

model UserExerciseResponse {
  id         String   @id @default(cuid())
  userId     String
  exerciseId String

  strengthGainRate Float?
  volumeResponse   Float?
  recoveryDemand   Float?
  enjoymentRating  Int?
  dataPoints       Int      @default(0)
  lastCalculated   DateTime @default(now())

  @@unique([userId, exerciseId])
}

// ─── Nutrition Extended ───────────────────────────────────────────────────────

model FavoriteMeal {
  id        String   @id @default(cuid())
  userId    String

  name      String
  calories  Float
  protein   Float
  carbs     Float
  fat       Float
  items     String?  // JSON array of food items

  timesUsed Int      @default(0)
  lastUsed  DateTime?
  createdAt DateTime @default(now())
}

// ─── Body Tracking ────────────────────────────────────────────────────────────

model BodyMeasurement {
  id     String @id @default(cuid())
  userId String

  date      DateTime @default(now())
  weight    Float?
  bodyFat   Float?
  chest     Float?
  waist     Float?
  hips      Float?
  bicepLeft  Float?
  bicepRight Float?
  thighLeft  Float?
  thighRight Float?
  calfLeft   Float?
  calfRight  Float?
  notes     String?
}

model ProgressPhoto {
  id       String   @id @default(cuid())
  userId   String

  imageUrl String
  date     DateTime @default(now())
  type     String   // front, side, back
  notes    String?
  weight   Float?
  bodyFat  Float?
}

// ─── Progression Tracking ─────────────────────────────────────────────────────

model ProgressionLog {
  id         String   @id @default(cuid())
  userId     String
  exerciseId String

  week   Int
  weight Float
  reps   Int
  sets   Int
  volume Float  // weight * reps * sets
  e1rm   Float  // estimated 1RM

  createdAt DateTime @default(now())

  @@index([userId, exerciseId])
}

// ─── Subscriptions ────────────────────────────────────────────────────────────

model Subscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tier   String @default("free")   // free, pro, elite
  status String @default("active") // active, cancelled, past_due

  stripeCustomerId     String?
  stripeSubscriptionId String?

  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  trialEnd           DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Social Platform ──────────────────────────────────────────────────────────

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  follower    User     @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
}

model FollowRequest {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  sender     User     @relation("RequestSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver   User     @relation("RequestReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  status     String   @default("pending") // pending, accepted, rejected
  createdAt  DateTime @default(now())

  @@unique([senderId, receiverId])
}

model Block {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([blockerId, blockedId])
}

model Activity {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // workout_completed, pr_hit, streak_milestone, started_program
  data      Json
  isPublic  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@index([userId])
}

model SharedWorkout {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutId   String
  workout     Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  title       String?
  description String?
  isPublic    Boolean  @default(true)
  likes       Like[]
  comments    Comment[]
  copies      WorkoutCopy[]
  createdAt   DateTime @default(now())
}

model WorkoutCopy {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sharedWorkoutId String
  sharedWorkout   SharedWorkout @relation(fields: [sharedWorkoutId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())
}

model Like {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sharedWorkoutId String
  sharedWorkout   SharedWorkout @relation(fields: [sharedWorkoutId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())

  @@unique([userId, sharedWorkoutId])
}

model Comment {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sharedWorkoutId String
  sharedWorkout   SharedWorkout @relation(fields: [sharedWorkoutId], references: [id], onDelete: Cascade)
  content         String
  createdAt       DateTime      @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // new_follower, workout_copied, workout_liked, comment, follow_request
  data      Json
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
}

model Report {
  id          String   @id @default(cuid())
  reporterId  String
  reportedId  String?
  contentId   String?
  contentType String   // user, workout, comment
  reason      String
  details     String?
  status      String   @default("pending") // pending, reviewed, resolved
  createdAt   DateTime @default(now())
}

// ─── Cardio ───────────────────────────────────────────────────────────────────

model CardioActivity {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         String   // running, cycling, swimming, hiit, rowing, jump_rope, elliptical, walking, stair_climber, sports
  sport        String?
  duration     Int      // seconds
  distance     Float?
  pace         Float?
  calories     Float?
  avgHeartRate Int?
  maxHeartRate Int?
  routeData    Json?
  intervals    Json?
  notes        String?
  createdAt    DateTime @default(now())

  @@index([userId])
}
