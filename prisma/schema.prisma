generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// â”€â”€â”€ User & Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Social identity
  username      String?  @unique
  displayName   String?
  bio           String?
  avatarUrl     String?
  isPrivate     Boolean  @default(false)

  profile         Profile?
  subscription    Subscription?
  workoutLogs     WorkoutLog[]
  nutritionLogs   NutritionLog[]
  weeklyReports   WeeklyReport[]
  achievements    UserAchievement[]
  streak          Streak?
  personalRecords PersonalRecord[]
  exerciseAnalytics UserExerciseAnalytics[]
  coachMessages   CoachMessage[]

  // Social relations
  followers        Follow[]        @relation("Following")
  following        Follow[]        @relation("Followers")
  activities       Activity[]
  sharedWorkouts   SharedWorkout[]
  likes            Like[]
  comments         Comment[]
  blockedUsers     Block[]         @relation("Blocker")
  blockedBy        Block[]         @relation("Blocked")
  notifications    Notification[]
  followRequests   FollowRequest[] @relation("RequestReceiver")
  sentRequests     FollowRequest[] @relation("RequestSender")
  cardioActivities  CardioActivity[]
  workoutCopies     WorkoutCopy[]
  healthData        HealthData[]
  stravaActivities  StravaActivity[]
  pushSubscriptions PushSubscription[]
  progressPhotos    ProgressPhoto[]

  // Strava OAuth
  stravaAccessToken  String?
  stravaRefreshToken String?
  stravaTokenExpiry  DateTime?
  stravaAthleteId    String?
  stravaConnected    Boolean  @default(false)

  // Notification preferences (JSON)
  notificationPreferences String @default("{}")

  // Admin
  isAdmin Boolean @default(false)

  // Referral
  referralCode     String?   @unique
  referralCredits  Int       @default(0)
  referredBy       String?
  referralsSent    Referral[] @relation("ReferralsSent")
  referralReceived Referral?  @relation("ReferralReceived")

  // Injury & challenges
  injuryFlags    InjuryFlag[]
  userInjuries   UserInjury[]
  challengeEntries ChallengeEntry[]
  friendshipsInitiated Friendship[] @relation("FriendshipUser")
  friendshipsReceived  Friendship[] @relation("FriendshipFriend")
  nutritionTarget NutritionTarget?

  // New features
  coachPersonality CoachPersonality?
  mealPlans        MealPlan[]
  seasons          Season[]
  bossBattleEntries BossBattleEntry[]

  // DMs
  messagesSent     Message[]      @relation("MessagesSent")
  messagesReceived Message[]      @relation("MessagesReceived")
  conversationsAsUser1 Conversation[] @relation("ConvUser1")
  conversationsAsUser2 Conversation[] @relation("ConvUser2")

  // Coach memory
  coachMemories    CoachMemory[]

  // Saved meals
  savedMeals       SavedMeal[]

  // Feed reactions
  reactions        Reaction[]
  feedComments     FeedComment[]

  // Waitlist & XP
  morningCheckIns  MorningCheckIn[]

  // Supplements
  supplementLogs   SupplementLog[]

  // Live workout sessions
  liveWorkoutSessions LiveWorkoutSession[] @relation("LiveWorkoutHost")
  liveWorkoutUpdates  LiveWorkoutUpdate[]  @relation("LiveWorkoutUpdates")
}

model Profile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic info
  name   String?
  age    Int?
  gender String? // male, female, other
  weight Float?  // in kg
  height Float?  // in cm

  // Onboarding
  goal            String? // fat_loss, muscle_gain, strength, endurance, general
  experienceLevel String? // beginner, intermediate, advanced
  trainingDays    Int?    // 2-6
  equipment       String? // full_gym, home_gym, minimal, bodyweight
  injuries        String  @default("[]") // JSON array
  sport           String? // basketball, running, mma, etc.

  // Calculated
  bmr            Float?
  tdee           Float?
  targetCalories Float?
  targetProtein  Float?
  targetCarbs    Float?
  targetFat      Float?

  // Preferences
  unitSystem String @default("imperial") // imperial or metric

  // Race / Event Goals
  raceGoals      Json?    // array of {type, date, priority}
  trainingVolume String?  // "beginner", "intermediate", "advanced"

  // Extended onboarding fields
  sessionLength   Int?    // 30, 45, 60, or 90 minutes
  nutritionGoal   String? // cut, maintain, bulk, performance
  limitations     String  @default("[]") // JSON array (replaces injuries conceptually)

  // Onboarding state
  onboardingDone  Boolean @default(false)
  goalDescription String?
  customGoal      String? // for "custom" goal type

  currentPlan TrainingPlan?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// â”€â”€â”€ Training System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model TrainingPlan {
  id        String  @id @default(cuid())
  userId    String  @unique
  profile   Profile @relation(fields: [userId], references: [userId], onDelete: Cascade)

  name            String  // "Hypertrophy Block 1"
  type            String  // custom, strength, hypertrophy, powerlifting, sport_specific
  split           String  // ppl, upper_lower, full_body, bro_split
  daysPerWeek     Int
  currentWeek     Int     @default(1)
  currentPhase    String? // accumulation, intensification, peaking, deload

  mesocycleLength Int @default(4) // weeks
  deloadFrequency Int @default(4) // every N weeks

  workouts Workout[]

  startedAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Workout {
  id     String       @id @default(cuid())
  planId String
  plan   TrainingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  name      String  // "Push A", "Upper Body"
  dayOfWeek Int?    // 0-6
  order     Int

  exercises      WorkoutExercise[]
  logs           WorkoutLog[]
  sharedWorkouts SharedWorkout[]

  createdAt DateTime @default(now())
}

model Exercise {
  id   String @id @default(cuid())
  name String @unique
  slug String? @unique

  category         String  // strength, cardio, flexibility, plyometric, olympic
  muscleGroups     String  @default("[]") // JSON array â€” primary muscles
  secondaryMuscles String  @default("[]") // JSON array â€” secondary muscles
  equipment        String  @default("[]") // JSON array
  movementPattern  String? // push, pull, hinge, squat, carry, rotate, isometric
  fatigueRating    Float   @default(1.0)
  skillLevel       String  @default("beginner") // beginner, intermediate, advanced
  avoidIfInjury    String  @default("[]") // JSON array (contraindications)
  instructions     String? // legacy single string
  formTips         String  @default("[]") // JSON array â€” step-by-step instructions
  commonMistakes   String  @default("[]") // JSON array
  coachingCues     String  @default("[]") // JSON array â€” technique tips
  alternatives     String  @default("[]") // JSON array â€” alternative exercise names
  videoUrl         String?

  // Exercise visuals
  gifUrl                String?
  imageUrl              String?
  muscleImageUrl        String?
  primaryMuscleImageUrl String?
  externalId            String?
  source                String? @default("custom") // exercisedb, wger, custom

  createdAt DateTime @default(now())

  workoutExercises WorkoutExercise[]
  exerciseLogs     ExerciseLog[]
  personalRecords  PersonalRecord[]
}

model NutritionCache {
  id        String   @id @default(cuid())
  query     String   @unique
  results   Json
  createdAt DateTime @default(now())
  expiresAt DateTime
}

model WorkoutExercise {
  id         String   @id @default(cuid())
  workoutId  String
  workout    Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id])

  order        Int
  sets         Int
  repsMin      Int
  repsMax      Int
  rpe          Float?
  restSeconds  Int    @default(120)
  supersetGroup Int?
  notes        String?
  tempo        String?  // e.g. "3-1-1-0" (eccentric-pause-concentric-pause)
  dropSets     Int    @default(0) // number of drop sets after working sets
}

// â”€â”€â”€ Logging & Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model WorkoutLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutId String
  workout   Workout  @relation(fields: [workoutId], references: [id])

  startedAt   DateTime
  completedAt DateTime?
  duration    Int? // minutes

  exerciseLogs ExerciseLog[]

  overallRpe  Float?
  energyLevel Int?
  mood        Int?
  notes       String?

  createdAt DateTime @default(now())
}

model ExerciseLog {
  id           String     @id @default(cuid())
  workoutLogId String
  workoutLog   WorkoutLog @relation(fields: [workoutLogId], references: [id], onDelete: Cascade)
  exerciseId   String
  exercise     Exercise   @relation(fields: [exerciseId], references: [id])

  sets SetLog[]

  createdAt DateTime @default(now())
}

model SetLog {
  id            String      @id @default(cuid())
  exerciseLogId String
  exerciseLog   ExerciseLog @relation(fields: [exerciseLogId], references: [id], onDelete: Cascade)

  setNumber    Int
  weight       Float
  reps         Int
  rpe          Float?
  rir          Int?
  isWarmup     Boolean  @default(false)
  isPR         Boolean  @default(false)
  isDropSet    Boolean  @default(false)
  dropSetNumber Int?
  tempo        String?
  completedAt  DateTime @default(now())
}

model PersonalRecord {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exerciseId String
  exercise   Exercise @relation(fields: [exerciseId], references: [id])

  type       String // 1rm, 3rm, 5rm, volume
  value      Float
  reps       Int?
  achievedAt DateTime @default(now())
}

// â”€â”€â”€ Nutrition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model NutritionLog {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  date    DateTime @default(now())
  meal    String   @default("snack") // "breakfast" | "lunch" | "dinner" | "snack"
  foodName String  @default("")
  calories Float
  protein  Float
  carbs    Float
  fat      Float
  quantity Float    @default(1)
  unit     String   @default("serving") // "g" | "oz" | "cup" | "serving"
  source   String   @default("manual")  // "manual" | "barcode" | "ai"

  mealName        String?
  foodDescription String?

  createdAt DateTime @default(now())
}

// â”€â”€â”€ AI Intelligence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model WeeklyReport {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  weekStart DateTime
  weekEnd   DateTime

  workoutsCompleted Int
  totalVolume       Float
  avgRpe            Float?
  prsHit            Int
  streakDays        Int

  insights        String @default("[]") // JSON array
  recommendations String @default("[]") // JSON array

  volumeTrend    String?
  strengthTrend  String?
  recoveryScore  Float?

  // AI-generated fields
  overallScore      Int?
  motivationalNote  String?
  focusForNextWeek  String?
  nutritionAdherence Float?
  planAdjustments   String @default("[]") // JSON array
  warnings          String @default("[]") // JSON array

  createdAt DateTime @default(now())
}

model UserExerciseAnalytics {
  id         String @id @default(cuid())
  userId     String
  user       User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  exerciseId String

  estimatedMax    Float?
  volumeResponse  Float?
  fatigueResponse Float?
  optimalRepRange String?
  optimalVolume   Int?

  lastUpdated DateTime @updatedAt

  @@unique([userId, exerciseId])
}

// â”€â”€â”€ Gamification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Achievement {
  id          String @id @default(cuid())
  code        String @unique
  name        String
  description String
  icon        String
  category    String // strength, consistency, nutrition, milestone
  requirement String // JSON condition
  xpReward    Int    @default(100)

  users UserAchievement[]
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id])

  unlockedAt DateTime @default(now())

  @@unique([userId, achievementId])
}

model Streak {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  currentStreak   Int       @default(0)
  longestStreak   Int       @default(0)
  lastWorkoutDate DateTime?
  totalXP         Int       @default(0)
  level           Int       @default(1)
  totalWorkouts   Int       @default(0)

  updatedAt DateTime @updatedAt
}

// â”€â”€â”€ AI Coach â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model CoachMessage {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String   // user | coach
  content   String
  createdAt DateTime @default(now())

  @@index([userId])
}

model UserExerciseResponse {
  id         String   @id @default(cuid())
  userId     String
  exerciseId String

  strengthGainRate Float?
  volumeResponse   Float?
  recoveryDemand   Float?
  enjoymentRating  Int?
  dataPoints       Int      @default(0)
  lastCalculated   DateTime @default(now())

  @@unique([userId, exerciseId])
}

// â”€â”€â”€ Nutrition Extended â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model FavoriteMeal {
  id        String   @id @default(cuid())
  userId    String

  name      String
  calories  Float
  protein   Float
  carbs     Float
  fat       Float
  items     String?  // JSON array of food items

  timesUsed Int      @default(0)
  lastUsed  DateTime?
  createdAt DateTime @default(now())
}

// â”€â”€â”€ Body Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model BodyMeasurement {
  id     String @id @default(cuid())
  userId String

  date       DateTime @default(now())
  weight     Float?
  bodyFat    Float?
  neck       Float?
  chest      Float?
  waist      Float?
  hips       Float?
  bicepLeft  Float?
  bicepRight Float?
  thighLeft  Float?
  thighRight Float?
  calfLeft   Float?
  calfRight  Float?
  notes      String?
}

model ProgressPhoto {
  id       String   @id @default(cuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  imageUrl  String
  photoUrl  String?  // alias kept for API compatibility
  date      DateTime @default(now())
  type      String?  // front, side, back
  notes     String?
  weight    Float?
  bodyFat   Float?
  isPrivate Boolean  @default(true)

  createdAt DateTime @default(now())
}

// â”€â”€â”€ Progression Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model ProgressionLog {
  id         String   @id @default(cuid())
  userId     String
  exerciseId String

  week   Int
  weight Float
  reps   Int
  sets   Int
  volume Float  // weight * reps * sets
  e1rm   Float  // estimated 1RM

  createdAt DateTime @default(now())

  @@index([userId, exerciseId])
}

// â”€â”€â”€ Subscriptions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Subscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tier   String @default("free")   // free, pro, elite
  status String @default("active") // active, cancelled, past_due

  stripeCustomerId     String?
  stripeSubscriptionId String?

  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  trialEnd           DateTime?

  // AI message rate limiting
  aiMessagesUsedToday Int      @default(0)
  aiMessagesResetAt   DateTime @default(now())

  // Morning check-in cache
  morningCheckinMessage String?
  morningCheckinDate    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// â”€â”€â”€ Social Platform â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  follower    User     @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
}

model FollowRequest {
  id         String   @id @default(cuid())
  senderId   String
  receiverId String
  sender     User     @relation("RequestSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver   User     @relation("RequestReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  status     String   @default("pending") // pending, accepted, rejected
  createdAt  DateTime @default(now())

  @@unique([senderId, receiverId])
}

model Block {
  id        String   @id @default(cuid())
  blockerId String
  blockedId String
  blocker   User     @relation("Blocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked   User     @relation("Blocked", fields: [blockedId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([blockerId, blockedId])
}

model Activity {
  id        String        @id @default(cuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String        // workout_completed, pr_hit, streak_milestone, started_program
  data      Json
  isPublic  Boolean       @default(true)
  createdAt DateTime      @default(now())
  reactions Reaction[]
  feedComments FeedComment[]

  @@index([userId])
}

model SharedWorkout {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutId   String
  workout     Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  title       String?
  description String?
  isPublic    Boolean  @default(true)
  likes       Like[]
  comments    Comment[]
  copies      WorkoutCopy[]
  createdAt   DateTime @default(now())
}

model WorkoutCopy {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sharedWorkoutId String
  sharedWorkout   SharedWorkout @relation(fields: [sharedWorkoutId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())
}

model Like {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sharedWorkoutId String
  sharedWorkout   SharedWorkout @relation(fields: [sharedWorkoutId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now())

  @@unique([userId, sharedWorkoutId])
}

model Comment {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sharedWorkoutId String
  sharedWorkout   SharedWorkout @relation(fields: [sharedWorkoutId], references: [id], onDelete: Cascade)
  content         String
  createdAt       DateTime      @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // new_follower, workout_copied, workout_liked, comment, follow_request, reaction, achievement, system
  title     String   @default("")
  body      String   @default("")
  data      Json     @default("{}")
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
}

model Report {
  id          String   @id @default(cuid())
  reporterId  String
  reportedId  String?
  contentId   String?
  contentType String   // user, workout, comment
  reason      String
  details     String?
  status      String   @default("pending") // pending, reviewed, resolved
  createdAt   DateTime @default(now())
}

// â”€â”€â”€ Cardio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model CardioActivity {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         String   // run, swim, bike, row, sprint, hiit, walking, jump_rope, elliptical, stair_climber, sports
  sport        String?
  title        String?  // e.g. "400m Sprint Intervals"
  description  String?  // full instructions
  intensity    String?  // "easy", "moderate", "hard", "max"
  date         DateTime?
  duration     Int      // seconds (logged) or minutes (planned)
  distance     Float?
  pace         Float?
  calories     Float?
  avgHeartRate Int?
  maxHeartRate Int?
  routeData    Json?
  intervals    Json?    // optional structured interval data
  notes        String?
  completed    Boolean  @default(false)
  completedAt  DateTime?
  createdAt    DateTime @default(now())

  @@index([userId])
}

// â”€â”€â”€ Health Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model HealthData {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date           DateTime
  sleepHours     Float?
  sleepQuality   Int?     // 1-10 self reported
  energyLevel    Int?     // 1-10
  soreness       String?  // none, mild, moderate, severe
  hrvScore       Float?   // ms
  restingHR      Int?     // bpm
  steps          Int?
  activeCalories Int?
  weight         Float?   // kg
  source         String   @default("manual") // manual, apple_health, garmin, strava
  createdAt      DateTime @default(now())

  @@unique([userId, date])
  @@index([userId])
}

// â”€â”€â”€ Strava â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model StravaActivity {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stravaId     String   @unique
  name         String
  type         String   // Run, Ride, Swim, etc.
  date         DateTime
  distance     Float    // meters
  duration     Int      // seconds
  elevation    Float?   // meters
  avgHeartRate Int?
  maxHeartRate Int?
  avgPace      Float?   // seconds per km
  calories     Int?
  imported     Boolean  @default(true)
  createdAt    DateTime @default(now())

  @@index([userId])
}

// â”€â”€â”€ Push Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  @@index([userId])
}

// â”€â”€â”€ Referral â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Referral {
  id          String    @id @default(cuid())
  referrerId  String
  referredId  String? @unique
  referralCode String   @unique
  email       String?
  status      String    @default("pending") // "pending" | "signed_up" | "converted"
  rewardGiven Boolean   @default(false)
  createdAt   DateTime  @default(now())
  convertedAt DateTime?
  referrer    User      @relation("ReferralsSent", fields: [referrerId], references: [id])
  referred    User?     @relation("ReferralReceived", fields: [referredId], references: [id])
}

// â”€â”€â”€ Injury Prevention â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model InjuryFlag {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type         String   // "overuse" | "volume_spike" | "imbalance" | "fatigue"
  severity     String   // "info" | "warning" | "alert"
  muscle       String?
  message      String
  acknowledged Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([userId])
}

model UserInjury {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  area      String
  severity  String    // "mild" | "moderate" | "severe"
  startDate DateTime
  endDate   DateTime?
  active    Boolean   @default(true)
  notes     String?
  createdAt DateTime  @default(now())

  @@index([userId])
}

// â”€â”€â”€ Nutrition Target â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model NutritionTarget {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  calories  Int
  protein   Int
  carbs     Int
  fat       Int
  phase     String   @default("maintain") // "cut" | "maintain" | "bulk"
  updatedAt DateTime @updatedAt
}

// â”€â”€â”€ Challenges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Challenge {
  id          String           @id @default(cuid())
  title       String
  description String
  type        String           // "run_distance" | "workout_count" | "streak" | "lift_volume"
  target      Float
  unit        String           // "km" | "workouts" | "days" | "kg"
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  entries     ChallengeEntry[]
}

model ChallengeEntry {
  id          String    @id @default(cuid())
  challengeId String
  userId      String
  progress    Float     @default(0)
  completed   Boolean   @default(false)
  completedAt DateTime?
  challenge   Challenge @relation(fields: [challengeId], references: [id])
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userId])
}

// â”€â”€â”€ Friendship â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Friendship {
  id        String   @id @default(cuid())
  userId    String
  friendId  String
  status    String   @default("pending") // "pending" | "accepted" | "blocked"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation("FriendshipUser", fields: [userId], references: [id], onDelete: Cascade)
  friend    User     @relation("FriendshipFriend", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
}

// â”€â”€â”€ AI Personality Profiling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model CoachPersonality {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tonePreference    String   @default("balanced") // tough_love | encouragement | balanced
  observations      Json     @default("[]")        // [{date, note, category}]
  weakDays          Json     @default("[]")        // ["Wednesday", "Friday"]
  stallingExercises Json     @default("[]")        // [{name, weeksStalled}]
  strongExercises   Json     @default("[]")        // [{name, rate}]
  totalInteractions Int      @default(0)
  lastAnalyzed      DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// â”€â”€â”€ Meal Planning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model MealPlan {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  weekStart     DateTime
  days          Json     // [{day, meals:[{name,foods:[{name,qty,unit}],calories,protein,carbs,fat}]}]
  groceryList   Json     // [{category, items:[{name,qty,unit}]}]
  calorieTarget Int
  proteinTarget Int
  carbsTarget   Int
  fatTarget     Int
  generatedAt   DateTime @default(now())

  @@index([userId])
}

// â”€â”€â”€ Training Seasons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Season {
  id                 String   @id @default(cuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name               String
  goalDescription    String
  startDate          DateTime
  endDate            DateTime
  benchmarkExercises Json     @default("[]") // [{exerciseId,name,baselineWeight,baselineReps,currentWeight,currentReps}]
  status             String   @default("active") // active | completed | abandoned
  finalResults       Json?
  weekNumber         Int      @default(1)
  createdAt          DateTime @default(now())

  seasonXP SeasonXP[]

  @@index([userId])
}

model SeasonXP {
  id        String   @id @default(cuid())
  userId    String
  seasonId  String
  season    Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  totalXP   Int      @default(0)
  updatedAt DateTime @updatedAt

  @@unique([userId, seasonId])
  @@index([seasonId])
}

// â”€â”€â”€ Journal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model JournalEntry {
  id        String   @id @default(cuid())
  userId    String
  entry     String
  mood      String?
  date      DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([userId, date])
}

// â”€â”€â”€ Boss Battles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model BossBattle {
  id           String           @id @default(cuid())
  month        Int
  year         Int
  name         String
  description  String
  bossIcon     String           @default("ðŸ‘¹")
  requirements Json             // [{type,target,unit,label}]
  xpReward     Int              @default(500)
  entries      BossBattleEntry[]

  @@unique([month, year])
}

model BossBattleEntry {
  id           String     @id @default(cuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  bossBattleId String
  bossBattle   BossBattle @relation(fields: [bossBattleId], references: [id])
  progress     Json       @default("{}") // {workouts:0, volume:0, cardio_minutes:0}
  defeated     Boolean    @default(false)
  defeatedAt   DateTime?
  joinedAt     DateTime   @default(now())

  @@unique([userId, bossBattleId])
  @@index([userId])
}

// â”€â”€â”€ Direct Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Conversation {
  id            String    @id @default(cuid())
  user1Id       String
  user2Id       String
  user1         User      @relation("ConvUser1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2         User      @relation("ConvUser2", fields: [user2Id], references: [id], onDelete: Cascade)
  lastMessage   String?
  lastMessageAt DateTime?
  messages      Message[]
  createdAt     DateTime  @default(now())

  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  receiverId     String
  sender         User         @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)
  receiver       User         @relation("MessagesReceived", fields: [receiverId], references: [id], onDelete: Cascade)
  content        String
  read           Boolean      @default(false)
  createdAt      DateTime     @default(now())

  @@index([conversationId])
  @@index([senderId])
  @@index([receiverId])
}

// â”€â”€â”€ Coach Memory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model CoachMemory {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  memory    String
  type      String   // preference | achievement | struggle | goal | personal
  createdAt DateTime @default(now())

  @@index([userId])
}

// â”€â”€â”€ Saved Meals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model SavedMeal {
  id       String   @id @default(cuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name     String
  items    Json     // [{foodName, calories, protein, carbs, fat, quantity, unit}]
  calories Int
  protein  Float
  carbs    Float
  fat      Float
  createdAt DateTime @default(now())

  @@index([userId])
}

// â”€â”€â”€ Feed Reactions & Comments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Reaction {
  id         String   @id @default(cuid())
  activityId String
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emoji      String   // fire | strong | clap | star

  @@unique([activityId, userId, emoji])
  @@index([activityId])
}

model FeedComment {
  id         String   @id @default(cuid())
  activityId String
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  content    String
  createdAt  DateTime @default(now())

  @@index([activityId])
}

// â”€â”€â”€ Waitlist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model WaitlistEntry {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  goal      String?
  source    String?
  createdAt DateTime @default(now())
}

// â”€â”€â”€ Page Analytics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model PageView {
  id        String   @id @default(cuid())
  userId    String?
  path      String
  userAgent String?
  country   String?
  createdAt DateTime @default(now())

  @@index([path, createdAt])
}

// â”€â”€â”€ Morning Check-In â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model MorningCheckIn {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date          DateTime @default(now())
  sleepHours    Float?
  sleepQuality  Int?
  energyLevel   Int?
  sorenessLevel Int?
  sorenessAreas String   @default("[]")
  stressLevel   Int?
  notes         String?
  recoveryScore Int?
  createdAt     DateTime @default(now())

  @@index([userId, date])
}

// â”€â”€â”€ Race Goal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model RaceGoal {
  id        String   @id @default(cuid())
  userId    String
  name      String
  type      String
  date      DateTime
  goalTime  String?
  status    String   @default("upcoming")
  result    String?
  notes     String?
  createdAt DateTime @default(now())
}

// â”€â”€â”€ Live Workout Sessions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model LiveWorkoutSession {
  id        String               @id @default(cuid())
  roomCode  String               @unique
  hostId    String
  host      User                 @relation("LiveWorkoutHost", fields: [hostId], references: [id], onDelete: Cascade)
  status    String               @default("active") // active | completed
  createdAt DateTime             @default(now())
  updates   LiveWorkoutUpdate[]

  @@index([hostId])
  @@index([roomCode])
}

model LiveWorkoutUpdate {
  id        String              @id @default(cuid())
  sessionId String
  session   LiveWorkoutSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId    String
  user      User                @relation("LiveWorkoutUpdates", fields: [userId], references: [id], onDelete: Cascade)
  type      String              // "set_complete" | "reaction" | "join" | "leave"
  data      Json                // {exercise, weight, reps, emoji, message}
  createdAt DateTime            @default(now())

  @@index([sessionId, createdAt])
  @@index([userId])
}

// â”€â”€â”€ Supplement Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model SupplementLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  dose      String?
  time      String?
  date      DateTime @default(now())
  createdAt DateTime @default(now())

  @@index([userId, date])
}
