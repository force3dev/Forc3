"use strict";(()=>{var e={};e.id=818,e.ids=[818],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46697:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>y,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>k});var a={};r.r(a),r.d(a,{GET:()=>w,POST:()=>p,dynamic:()=>d});var o=r(49303),n=r(88716),i=r(60670),s=r(87070),u=r(61165),c=r(20728),l=r(41295);let d="force-dynamic";async function p(e){let t=await (0,u.rc)();if(!t)return s.NextResponse.json({error:"Unauthorized"},{status:401});try{let o=await e.json(),{action:n}=o;if("start"===n){let e=await c._.workoutLog.create({data:{userId:t,workoutId:o.workoutId,startedAt:new Date,notes:o.notes||null}});return s.NextResponse.json({logId:e.id})}if("log_set"===n){var r,a;let{logId:e,exerciseId:n,setNumber:i,weight:u,reps:d,rpe:p,isWarmup:w}=o,m=await c._.exerciseLog.findFirst({where:{workoutLogId:e,exerciseId:n}});m||(m=await c._.exerciseLog.create({data:{workoutLogId:e,exerciseId:n}}));let y=await c._.personalRecord.findFirst({where:{userId:t,exerciseId:n,type:"1rm"},orderBy:{value:"desc"}}),k=(r=u,a=d,1===a?r:Math.round(((1===a?r:Math.round(r*(1+a/30)))+(1===a?r:a>=37?1.5*r:Math.round(36/(37-a)*r)))/2)),f=!y||k>y.value,h=await c._.personalRecord.findFirst({where:{userId:t,exerciseId:n,type:"volume"},orderBy:{value:"desc"}}),v=u*d,x=!h||v>h.value,_=f||x,D=await c._.setLog.create({data:{exerciseLogId:m.id,setNumber:i,weight:u,reps:d,rpe:p||null,isWarmup:w||!1,isPR:_}});return!w&&(f&&await c._.personalRecord.create({data:{userId:t,exerciseId:n,type:"1rm",value:k,reps:d}}),x&&await c._.personalRecord.create({data:{userId:t,exerciseId:n,type:"volume",value:v,reps:d}})),await g(t),_&&!w&&(await (0,l.Mu)(),await (0,l.am)(t)),s.NextResponse.json({setId:D.id,isPR:_,prType:f?"1rm":x?"volume":null,estimated1RM:k,exerciseLogId:m.id})}if("complete"===n){let{logId:e,overallRpe:r,energyLevel:a,mood:n,notes:i}=o,u=await c._.workoutLog.findFirst({where:{id:e,userId:t},include:{exerciseLogs:{include:{sets:!0}}}});if(!u)return s.NextResponse.json({error:"Log not found"},{status:404});let d=Math.round((Date.now()-u.startedAt.getTime())/6e4),p=u.exerciseLogs.reduce((e,t)=>e+t.sets.reduce((e,t)=>e+t.weight*t.reps,0),0);await c._.workoutLog.update({where:{id:e},data:{completedAt:new Date,duration:d,overallRpe:r||null,energyLevel:a||null,mood:n||null,notes:i||null}}),await (0,l.Mu)();let w=await (0,l.am)(t);return s.NextResponse.json({success:!0,duration:d,totalVolume:p,newAchievements:w})}return s.NextResponse.json({error:"Invalid action"},{status:400})}catch(e){return console.error("Workout log error:",e),s.NextResponse.json({error:"Failed to log workout"},{status:500})}}async function w(e){let t=await (0,u.rc)();if(!t)return s.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),a=parseInt(r.get("limit")||"20"),o=parseInt(r.get("offset")||"0"),n=await c._.workoutLog.findMany({where:{userId:t,completedAt:{not:null}},include:{workout:{select:{name:!0}},exerciseLogs:{include:{exercise:{select:{name:!0}},sets:{orderBy:{setNumber:"asc"}}}}},orderBy:{startedAt:"desc"},take:a,skip:o});return s.NextResponse.json({logs:n})}async function g(e){let t=new Date;t.setHours(0,0,0,0);let r=await c._.streak.findUnique({where:{userId:e}});if(!r){await c._.streak.create({data:{userId:e,currentStreak:1,longestStreak:1,lastWorkoutDate:new Date}});return}let a=r.lastWorkoutDate;if(!a){await c._.streak.update({where:{userId:e},data:{currentStreak:1,longestStreak:Math.max(1,r.longestStreak),lastWorkoutDate:new Date}});return}let o=new Date(a);o.setHours(0,0,0,0);let n=Math.round((t.getTime()-o.getTime())/864e5);if(0!==n){if(1===n||2===n){let t=r.currentStreak+1;await c._.streak.update({where:{userId:e},data:{currentStreak:t,longestStreak:Math.max(t,r.longestStreak),lastWorkoutDate:new Date}})}else await c._.streak.update({where:{userId:e},data:{currentStreak:1,lastWorkoutDate:new Date}})}}let m=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/workouts/log/route",pathname:"/api/workouts/log",filename:"route",bundlePath:"app/api/workouts/log/route"},resolvedPagePath:"C:\\Users\\Geric\\Desktop\\forc3\\src\\app\\api\\workouts\\log\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:k,serverHooks:f}=m,h="/api/workouts/log/route";function v(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:k})}},95456:(e,t,r)=>{r.d(t,{AX:()=>d,Gg:()=>l,Rf:()=>p,ed:()=>u});var a=r(86890),o=r(41463),n=r(71615);let i=new TextEncoder().encode(process.env.JWT_SECRET||process.env.NEXTAUTH_SECRET||"forc3-secret-key-change-in-production"),s="forc3_session";async function u(e){return await new a.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("30d").sign(i)}async function c(e){try{let{payload:t}=await (0,o._)(e,i);return t}catch{return null}}async function l(){let e=await (0,n.cookies)(),t=e.get(s)?.value;return t?c(t):null}function d(e){return{name:s,value:e,httpOnly:!0,secure:!0,sameSite:"lax",maxAge:2592e3,path:"/"}}function p(){return{name:s,value:"",httpOnly:!0,secure:!0,sameSite:"lax",maxAge:0,path:"/"}}},41295:(e,t,r)=>{r.d(t,{Mu:()=>n,am:()=>i});var a=r(20728);let o=[{code:"first_workout",name:"First Sweat",description:"Complete your first workout",icon:"\uD83C\uDFCB️",category:"milestone",requirement:JSON.stringify({type:"workouts_completed",value:1}),xpReward:50},{code:"ten_workouts",name:"Getting Consistent",description:"Complete 10 workouts",icon:"\uD83D\uDCAA",category:"milestone",requirement:JSON.stringify({type:"workouts_completed",value:10}),xpReward:100},{code:"fifty_workouts",name:"Dedicated Athlete",description:"Complete 50 workouts",icon:"\uD83D\uDD11",category:"milestone",requirement:JSON.stringify({type:"workouts_completed",value:50}),xpReward:250},{code:"first_pr",name:"Personal Best",description:"Set your first personal record",icon:"\uD83C\uDFC6",category:"strength",requirement:JSON.stringify({type:"prs_total",value:1}),xpReward:75},{code:"ten_prs",name:"PR Machine",description:"Set 10 personal records",icon:"\uD83E\uDD47",category:"strength",requirement:JSON.stringify({type:"prs_total",value:10}),xpReward:200},{code:"streak_7",name:"Week Warrior",description:"Maintain a 7-day workout streak",icon:"\uD83D\uDD25",category:"consistency",requirement:JSON.stringify({type:"streak",value:7}),xpReward:150},{code:"streak_30",name:"Iron Discipline",description:"Maintain a 30-day workout streak",icon:"⚡",category:"consistency",requirement:JSON.stringify({type:"streak",value:30}),xpReward:500},{code:"volume_100k",name:"Century Club",description:"Lift 100,000 lbs total volume",icon:"\uD83E\uDDBE",category:"strength",requirement:JSON.stringify({type:"total_volume",value:1e5}),xpReward:300},{code:"sets_100",name:"The Grinder",description:"Log 100 total sets",icon:"⚙️",category:"milestone",requirement:JSON.stringify({type:"total_sets",value:100}),xpReward:100},{code:"nutrition_logged",name:"Fueled Right",description:"Log your nutrition for the first time",icon:"\uD83E\uDD57",category:"nutrition",requirement:JSON.stringify({type:"nutrition_logs",value:1}),xpReward:50},{code:"nutrition_week",name:"Macro Master",description:"Log nutrition for 7 consecutive days",icon:"\uD83D\uDCCA",category:"nutrition",requirement:JSON.stringify({type:"nutrition_streak",value:7}),xpReward:200},{code:"perfect_week",name:"Perfect Week",description:"Hit 100% of your weekly training sessions",icon:"⭐",category:"consistency",requirement:JSON.stringify({type:"weekly_compliance",value:1}),xpReward:150}];async function n(){for(let e of o)await a._.achievement.upsert({where:{code:e.code},update:{name:e.name,description:e.description,icon:e.icon,xpReward:e.xpReward},create:e})}async function i(e){let[t,r,o,n]=await Promise.all([a._.workoutLog.findMany({where:{userId:e,completedAt:{not:null}},include:{exerciseLogs:{include:{sets:!0}}}}),a._.personalRecord.findMany({where:{userId:e}}),a._.streak.findUnique({where:{userId:e}}),a._.profile.findUnique({where:{userId:e}})]),i=t.length,s=t.reduce((e,t)=>e+t.exerciseLogs.reduce((e,t)=>e+t.sets.length,0),0),u=t.reduce((e,t)=>e+t.exerciseLogs.reduce((e,t)=>e+t.sets.reduce((e,t)=>e+t.weight*t.reps,0),0),0),c=r.length,l=o?.currentStreak||0,d=await a._.nutritionLog.count({where:{userId:e}}),p=new Set((await a._.userAchievement.findMany({where:{userId:e},select:{achievementId:!0}})).map(e=>e.achievementId)),w=await a._.achievement.findMany(),g=new Date,m=new Date(g);m.setDate(g.getDate()-(g.getDay()+6)%7),m.setHours(0,0,0,0);let y=await a._.trainingPlan.findUnique({where:{userId:e}}),k=y?.daysPerWeek||4,f=t.filter(e=>new Date(e.startedAt)>=m).length,h=f>=k?1:0,v=[];for(let t of w){if(p.has(t.id))continue;let r=JSON.parse(t.requirement),o=!1;switch(r.type){case"workouts_completed":o=i>=r.value;break;case"prs_total":o=c>=r.value;break;case"streak":o=l>=r.value;break;case"total_volume":o=u>=r.value;break;case"total_sets":o=s>=r.value;break;case"nutrition_logs":o=d>=r.value;break;case"nutrition_streak":o=d>=3*r.value;break;case"weekly_compliance":o=h>=r.value&&f>0}o&&(await a._.userAchievement.create({data:{userId:e,achievementId:t.id}}),v.push({code:t.code,name:t.name,icon:t.icon,xpReward:t.xpReward}))}return v}},20728:(e,t,r)=>{r.d(t,{_:()=>o});let a=require("@prisma/client"),o=globalThis.prisma||new a.PrismaClient({log:["warn","error"]})},61165:(e,t,r)=>{r.d(t,{rc:()=>o});var a=r(95456);async function o(){let e=await (0,a.Gg)();return e?.userId??null}r(20728)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,3112],()=>r(46697));module.exports=a})();