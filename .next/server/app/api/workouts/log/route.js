"use strict";(()=>{var e={};e.id=818,e.ids=[818,1165,3538],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},54335:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>_,requestAsyncStorage:()=>x,routeModule:()=>v,serverHooks:()=>R,staticGenerationAsyncStorage:()=>D});var a={};r.r(a),r.d(a,{GET:()=>k,POST:()=>y,dynamic:()=>g});var o=r(49303),n=r(88716),i=r(60670),s=r(87070),u=r(61165),l=r(13538),c=r(41295);let d={completeWorkout:100,newPR:150},p=[{level:1,name:"Rookie",minXP:0,maxXP:500},{level:2,name:"Athlete",minXP:500,maxXP:1500},{level:3,name:"Competitor",minXP:1500,maxXP:3500},{level:4,name:"Elite",minXP:3500,maxXP:7e3},{level:5,name:"Champion",minXP:7e3,maxXP:15e3},{level:6,name:"Legend",minXP:15e3,maxXP:1/0}];var m=r(34480);async function w(e){let t=[],r=new Date,a=new Date(r.getTime()-6048e5),o=new Date(r.getTime()-12096e5),[n,i,s]=await Promise.all([l.prisma.workoutLog.findMany({where:{userId:e,completedAt:{gte:a}},include:{exerciseLogs:{include:{sets:!0}}}}),l.prisma.workoutLog.findMany({where:{userId:e,completedAt:{gte:o,lt:a}},include:{exerciseLogs:{include:{sets:!0}}}}),l.prisma.workoutLog.findMany({where:{userId:e,completedAt:{gte:a}},orderBy:{completedAt:"desc"}})]),u=n.reduce((e,t)=>e+t.exerciseLogs.reduce((e,t)=>e+t.sets.reduce((e,t)=>e+t.weight*t.reps,0),0),0),c=i.reduce((e,t)=>e+t.exerciseLogs.reduce((e,t)=>e+t.sets.reduce((e,t)=>e+t.weight*t.reps,0),0),0);if(c>0&&u>1.3*c){let e=Math.round((u/c-1)*100);t.push({type:"volume_spike",severity:e>50?"alert":"warning",message:`Your training volume spiked ${e}% this week vs last week. Consider backing off 10–20% to avoid overreach.`})}new Set(s.map(e=>e.completedAt?.toDateString()).filter(Boolean)).size>=7&&t.push({type:"fatigue",severity:"warning",message:"You've trained every day this week. Your body needs at least 1 rest day to recover and adapt."});let d=s.filter(e=>e.completedAt).sort((e,t)=>t.completedAt.getTime()-e.completedAt.getTime()).filter(e=>(e.overallRpe??0)>=8).length;return d>=3&&t.push({type:"fatigue",severity:"warning",message:`${d} high-intensity sessions this week. Schedule an easy or rest day tomorrow — recovery is where gains happen.`}),t.length>0&&await l.prisma.injuryFlag.createMany({data:t.map(t=>({...t,userId:e})),skipDuplicates:!1}),t}let g="force-dynamic";async function y(e){let t=await (0,u.getCurrentUserId)();if(!t)return s.NextResponse.json({error:"Unauthorized"},{status:401});try{let o=await e.json(),{action:n}=o;if("start"===n){let e=await l.prisma.workoutLog.create({data:{userId:t,workoutId:o.workoutId,startedAt:new Date,notes:o.notes||null}});return s.NextResponse.json({logId:e.id})}if("log_set"===n){var r,a;let{logId:e,exerciseId:n,setNumber:i,weight:u,reps:p,rpe:m,isWarmup:w}=o,g=await l.prisma.exerciseLog.findFirst({where:{workoutLogId:e,exerciseId:n}});g||(g=await l.prisma.exerciseLog.create({data:{workoutLogId:e,exerciseId:n}}));let y=await l.prisma.personalRecord.findFirst({where:{userId:t,exerciseId:n,type:"1rm"},orderBy:{value:"desc"}}),k=(r=u,a=p,1===a?r:Math.round(((1===a?r:Math.round(r*(1+a/30)))+(1===a?r:a>=37?1.5*r:Math.round(36/(37-a)*r)))/2)),v=!y||k>y.value,x=await l.prisma.personalRecord.findFirst({where:{userId:t,exerciseId:n,type:"volume"},orderBy:{value:"desc"}}),D=u*p,R=!x||D>x.value,S=v||R,_=await l.prisma.setLog.create({data:{exerciseLogId:g.id,setNumber:i,weight:u,reps:p,rpe:m||null,isWarmup:w||!1,isPR:S}});return!w&&(v&&await l.prisma.personalRecord.create({data:{userId:t,exerciseId:n,type:"1rm",value:k,reps:p}}),R&&await l.prisma.personalRecord.create({data:{userId:t,exerciseId:n,type:"volume",value:D,reps:p}})),await h(t),S&&!w&&(await (0,c.Mu)(),await (0,c.am)(t),await f(t,d.newPR)),s.NextResponse.json({setId:_.id,isPR:S,prType:v?"1rm":R?"volume":null,estimated1RM:k,exerciseLogId:g.id})}if("complete"===n){let{logId:e,overallRpe:r,energyLevel:a,mood:n,notes:i}=o,u=await l.prisma.workoutLog.findFirst({where:{id:e,userId:t},include:{exerciseLogs:{include:{sets:!0}}}});if(!u)return s.NextResponse.json({error:"Log not found"},{status:404});let p=Math.round((Date.now()-u.startedAt.getTime())/6e4),g=u.exerciseLogs.reduce((e,t)=>e+t.sets.reduce((e,t)=>e+t.weight*t.reps,0),0);await l.prisma.workoutLog.update({where:{id:e},data:{completedAt:new Date,duration:p,overallRpe:r||null,energyLevel:a||null,mood:n||null,notes:i||null}}),await (0,c.Mu)();let y=await (0,c.am)(t);await f(t,d.completeWorkout);let k=u.workoutId?(await l.prisma.workout.findUnique({where:{id:u.workoutId},select:{name:!0}}))?.name??"Workout":"Workout";return(0,m.x)(t,"workout_complete",{workoutName:k||"Workout",duration:p,totalVolume:Math.round(g),xp:d.completeWorkout}).catch(()=>{}),w(t).catch(()=>{}),s.NextResponse.json({success:!0,duration:p,totalVolume:g,newAchievements:y})}return s.NextResponse.json({error:"Invalid action"},{status:400})}catch(e){return console.error("Workout log error:",e),s.NextResponse.json({error:"Failed to log workout"},{status:500})}}async function k(e){let t=await (0,u.getCurrentUserId)();if(!t)return s.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),a=parseInt(r.get("limit")||"20"),o=parseInt(r.get("offset")||"0"),n=await l.prisma.workoutLog.findMany({where:{userId:t,completedAt:{not:null}},include:{workout:{select:{name:!0}},exerciseLogs:{include:{exercise:{select:{name:!0}},sets:{orderBy:{setNumber:"asc"}}}}},orderBy:{startedAt:"desc"},take:a,skip:o});return s.NextResponse.json({logs:n})}async function f(e,t){let r=await l.prisma.streak.findUnique({where:{userId:e}});if(!r)return;let a=(r.totalXP||0)+t,o=([...p].reverse().find(e=>a>=e.minXP)??p[0]).level;await l.prisma.streak.update({where:{userId:e},data:{totalXP:a,level:o}})}async function h(e){let t=new Date;t.setHours(0,0,0,0);let r=await l.prisma.streak.findUnique({where:{userId:e}});if(!r){await l.prisma.streak.create({data:{userId:e,currentStreak:1,longestStreak:1,lastWorkoutDate:new Date,totalWorkouts:1}});return}let a=r.lastWorkoutDate;if(!a){await l.prisma.streak.update({where:{userId:e},data:{currentStreak:1,longestStreak:Math.max(1,r.longestStreak),lastWorkoutDate:new Date}});return}let o=new Date(a);o.setHours(0,0,0,0);let n=Math.round((t.getTime()-o.getTime())/864e5);if(0!==n){if(1===n||2===n){let t=r.currentStreak+1;await l.prisma.streak.update({where:{userId:e},data:{currentStreak:t,longestStreak:Math.max(t,r.longestStreak),lastWorkoutDate:new Date,totalWorkouts:(r.totalWorkouts||0)+1}})}else await l.prisma.streak.update({where:{userId:e},data:{currentStreak:1,lastWorkoutDate:new Date,totalWorkouts:(r.totalWorkouts||0)+1}})}}let v=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/workouts/log/route",pathname:"/api/workouts/log",filename:"route",bundlePath:"app/api/workouts/log/route"},resolvedPagePath:"C:\\Users\\Geric\\Desktop\\forc3\\src\\app\\api\\workouts\\log\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:x,staticGenerationAsyncStorage:D,serverHooks:R}=v,S="/api/workouts/log/route";function _(){return(0,i.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:D})}},34480:(e,t,r)=>{r.d(t,{x:()=>o});var a=r(13538);async function o(e,t,r,o=!0){try{await a.prisma.activity.create({data:{userId:e,type:t,data:r,isPublic:o}})}catch(e){console.error("[activity-feed] Failed to post activity:",e)}}},95456:(e,t,r)=>{r.d(t,{AX:()=>d,Gg:()=>c,Rf:()=>p,ed:()=>u});var a=r(86890),o=r(41463),n=r(71615);let i=new TextEncoder().encode(process.env.JWT_SECRET||process.env.NEXTAUTH_SECRET||"forc3-secret-key-change-in-production"),s="forc3_session";async function u(e){return await new a.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("30d").sign(i)}async function l(e){try{let{payload:t}=await (0,o._)(e,i);return t}catch{return null}}async function c(){let e=await (0,n.cookies)(),t=e.get(s)?.value;return t?l(t):null}function d(e){return{name:s,value:e,httpOnly:!0,secure:!0,sameSite:"lax",maxAge:2592e3,path:"/"}}function p(){return{name:s,value:"",httpOnly:!0,secure:!0,sameSite:"lax",maxAge:0,path:"/"}}},41295:(e,t,r)=>{r.d(t,{Mu:()=>n,am:()=>i});var a=r(13538);let o=[{code:"first_workout",name:"First Sweat",description:"Complete your first workout",icon:"\uD83C\uDFCB️",category:"milestone",requirement:JSON.stringify({type:"workouts_completed",value:1}),xpReward:50},{code:"ten_workouts",name:"Getting Consistent",description:"Complete 10 workouts",icon:"\uD83D\uDCAA",category:"milestone",requirement:JSON.stringify({type:"workouts_completed",value:10}),xpReward:100},{code:"fifty_workouts",name:"Dedicated Athlete",description:"Complete 50 workouts",icon:"\uD83D\uDD11",category:"milestone",requirement:JSON.stringify({type:"workouts_completed",value:50}),xpReward:250},{code:"first_pr",name:"Personal Best",description:"Set your first personal record",icon:"\uD83C\uDFC6",category:"strength",requirement:JSON.stringify({type:"prs_total",value:1}),xpReward:75},{code:"ten_prs",name:"PR Machine",description:"Set 10 personal records",icon:"\uD83E\uDD47",category:"strength",requirement:JSON.stringify({type:"prs_total",value:10}),xpReward:200},{code:"streak_7",name:"Week Warrior",description:"Maintain a 7-day workout streak",icon:"\uD83D\uDD25",category:"consistency",requirement:JSON.stringify({type:"streak",value:7}),xpReward:150},{code:"streak_30",name:"Iron Discipline",description:"Maintain a 30-day workout streak",icon:"⚡",category:"consistency",requirement:JSON.stringify({type:"streak",value:30}),xpReward:500},{code:"volume_100k",name:"Century Club",description:"Lift 100,000 lbs total volume",icon:"\uD83E\uDDBE",category:"strength",requirement:JSON.stringify({type:"total_volume",value:1e5}),xpReward:300},{code:"sets_100",name:"The Grinder",description:"Log 100 total sets",icon:"⚙️",category:"milestone",requirement:JSON.stringify({type:"total_sets",value:100}),xpReward:100},{code:"nutrition_logged",name:"Fueled Right",description:"Log your nutrition for the first time",icon:"\uD83E\uDD57",category:"nutrition",requirement:JSON.stringify({type:"nutrition_logs",value:1}),xpReward:50},{code:"nutrition_week",name:"Macro Master",description:"Log nutrition for 7 consecutive days",icon:"\uD83D\uDCCA",category:"nutrition",requirement:JSON.stringify({type:"nutrition_streak",value:7}),xpReward:200},{code:"perfect_week",name:"Perfect Week",description:"Hit 100% of your weekly training sessions",icon:"⭐",category:"consistency",requirement:JSON.stringify({type:"weekly_compliance",value:1}),xpReward:150}];async function n(){for(let e of o)await a.prisma.achievement.upsert({where:{code:e.code},update:{name:e.name,description:e.description,icon:e.icon,xpReward:e.xpReward},create:e})}async function i(e){let[t,r,o,n]=await Promise.all([a.prisma.workoutLog.findMany({where:{userId:e,completedAt:{not:null}},include:{exerciseLogs:{include:{sets:!0}}}}),a.prisma.personalRecord.findMany({where:{userId:e}}),a.prisma.streak.findUnique({where:{userId:e}}),a.prisma.profile.findUnique({where:{userId:e}})]),i=t.length,s=t.reduce((e,t)=>e+t.exerciseLogs.reduce((e,t)=>e+t.sets.length,0),0),u=t.reduce((e,t)=>e+t.exerciseLogs.reduce((e,t)=>e+t.sets.reduce((e,t)=>e+t.weight*t.reps,0),0),0),l=r.length,c=o?.currentStreak||0,d=await a.prisma.nutritionLog.count({where:{userId:e}}),p=new Set((await a.prisma.userAchievement.findMany({where:{userId:e},select:{achievementId:!0}})).map(e=>e.achievementId)),m=await a.prisma.achievement.findMany(),w=new Date,g=new Date(w);g.setDate(w.getDate()-(w.getDay()+6)%7),g.setHours(0,0,0,0);let y=await a.prisma.trainingPlan.findUnique({where:{userId:e}}),k=y?.daysPerWeek||4,f=t.filter(e=>new Date(e.startedAt)>=g).length,h=f>=k?1:0,v=[];for(let t of m){if(p.has(t.id))continue;let r=JSON.parse(t.requirement),o=!1;switch(r.type){case"workouts_completed":o=i>=r.value;break;case"prs_total":o=l>=r.value;break;case"streak":o=c>=r.value;break;case"total_volume":o=u>=r.value;break;case"total_sets":o=s>=r.value;break;case"nutrition_logs":o=d>=r.value;break;case"nutrition_streak":o=d>=3*r.value;break;case"weekly_compliance":o=h>=r.value&&f>0}o&&(await a.prisma.userAchievement.create({data:{userId:e,achievementId:t.id}}),v.push({code:t.code,name:t.name,icon:t.icon,xpReward:t.xpReward}))}return v}},13538:(e,t,r)=>{r.d(t,{prisma:()=>o});var a=r(53524);let o=globalThis.prisma||new a.PrismaClient({log:["warn","error"]})},61165:(e,t,r)=>{r.d(t,{getCurrentUserId:()=>o});var a=r(95456);async function o(){let e=await (0,a.Gg)();return e?.userId??null}r(13538)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[8948,5972,3112],()=>r(54335));module.exports=a})();