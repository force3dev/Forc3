"use strict";(()=>{var e={};e.id=6726,e.ids=[6726,3538],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},47874:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>_,requestAsyncStorage:()=>w,routeModule:()=>b,serverHooks:()=>v,staticGenerationAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{POST:()=>m,dynamic:()=>c});var a=r(49303),i=r(88716),o=r(60670),n=r(87070),u=r(13538),p=r(89777);let c="force-dynamic",d=process.env.STRIPE_SECRET_KEY?new p.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2026-01-28.clover"}):null,l=process.env.STRIPE_WEBHOOK_SECRET||"";async function m(e){let t;if(!d)return n.NextResponse.json({error:"Stripe not configured"},{status:503});let r=await e.text(),s=e.headers.get("stripe-signature")||"";try{t=d.webhooks.constructEvent(r,s,l)}catch(e){return console.error("Webhook signature error:",e),n.NextResponse.json({error:"Invalid signature"},{status:400})}let a=async e=>{let t=e.metadata?.userId,r=e.metadata?.tier||"pro";if(!t)return;let s=e.trial_end?new Date(1e3*e.trial_end):null,a=e.items?.data?.[0],i=a?.current_period_start,o=a?.current_period_end,n=i?new Date(1e3*i):new Date,p=o?new Date(1e3*o):new Date;await u.prisma.subscription.upsert({where:{userId:t},update:{tier:r,status:"active"===e.status||"trialing"===e.status?"active":e.status,stripeSubscriptionId:e.id,stripeCustomerId:e.customer,currentPeriodStart:n,currentPeriodEnd:p,trialEnd:s},create:{userId:t,tier:r,status:"active",stripeSubscriptionId:e.id,stripeCustomerId:e.customer,currentPeriodStart:n,currentPeriodEnd:p,trialEnd:s}})};switch(t.type){case"customer.subscription.created":case"customer.subscription.updated":await a(t.data.object);break;case"customer.subscription.deleted":{let e=t.data.object,r=e.metadata?.userId;r&&await u.prisma.subscription.update({where:{userId:r},data:{tier:"free",status:"cancelled"}});break}case"invoice.payment_failed":{let e=t.data.object;if(e.subscription){let t=await d.subscriptions.retrieve(e.subscription),r=t.metadata?.userId;r&&await u.prisma.subscription.update({where:{userId:r},data:{status:"past_due"}})}}}return n.NextResponse.json({received:!0})}let b=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/subscription/webhook/route",pathname:"/api/subscription/webhook",filename:"route",bundlePath:"app/api/subscription/webhook/route"},resolvedPagePath:"C:\\Users\\Geric\\Desktop\\forc3\\src\\app\\api\\subscription\\webhook\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:h,serverHooks:v}=b,x="/api/subscription/webhook/route";function _(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:h})}},13538:(e,t,r)=>{r.d(t,{prisma:()=>a});var s=r(53524);let a=globalThis.prisma||new s.PrismaClient({log:["warn","error"]})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,9777],()=>r(47874));module.exports=s})();